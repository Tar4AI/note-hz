<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Note → Hz</title>
<style>
  :root{
    --bg1:#0b1220; --bg2:#0a1120; --bg3:#0a0f1a;
    --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#10b981; --accent2:#22d3ee;
    --cellW: 60px;
    --black-width: 32px; --black-height: 120px;
    --black-width-lg: 36px; --black-height-lg: 130px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; color:var(--text);
    background: radial-gradient(1200px 600px at 50% -10%, var(--bg1) 0%, var(--bg2) 35%, var(--bg3) 100%);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", "Noto Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    -webkit-user-select:none; user-select:none; touch-action:manipulation;
  }
  .wrap{max-width:1100px; margin:0 auto; padding:16px}
  h1{font-size:clamp(18px,2vw,24px); font-weight:600; margin:0 0 12px}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .card{background:linear-gradient(180deg, rgba(17,24,39,.7), rgba(15,23,42,.7)); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 8px 28px rgba(0,0,0,.35)}
  .card + .card{margin-top:16px}
  .label{font-size:12px; color:var(--muted); margin-bottom:6px}
  .value{font-size:clamp(18px,2.6vw,22px); font-weight:700; font-variant-numeric: tabular-nums}
  .big{font-size:clamp(26px,4vw,34px); font-weight:800; font-variant-numeric: tabular-nums}
  .small{font-size:12px; color:var(--muted)}
  .controls{gap:16px}
  .controls label{display:flex; gap:8px; align-items:center; font-size:14px; cursor:pointer}
  input[type="checkbox"], input[type="range"], select{accent-color: var(--accent)}
  select{background:#111827; color:#e5e7eb; border:1px solid #374151; border-radius:10px; padding:6px 10px}

  .btn{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid #334155; background:rgba(17,24,39,.6); color:#e5e7eb; cursor:pointer; transition:.15s}
  .btn:hover{transform:translateY(-1px); border-color:#475569}
  .btn.on{border-color:var(--accent2); box-shadow:0 0 0 2px rgba(34,211,238,.15); color:#cffafe}

  .grid4{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px; margin-top:12px;}
  .box{display:flex; flex-direction:column; justify-content:center; border:1px solid #334155; background:rgba(30,41,59,.6); border-radius:12px; padding:10px 12px}
  .box .value{display:block}

  .kbd-wrap{position:relative; display:flex; gap:16px}
  .keyboard{position:relative; overflow-x:auto; padding:16px; border-radius:12px; background:rgba(0,0,0,.15); flex:1}
  .keys{display:flex}
  .cell{position:relative; width:var(--cellW)}
  .white{position:relative; width:100%; height:200px; background:#fff; color:#111; border:1px solid #4b5563; border-top:none; border-radius:0 0 8px 8px; box-shadow:0 4px 8px rgba(0,0,0,.35)}
  .white:active{transform:translateY(1px)}
  .wlab{position:absolute; bottom:8px; left:0; right:0; text-align:center; font-size:11px; color:#334155}
  .black{position:absolute; top:0; left:100%; transform:translateX(-50%); width:var(--black-width); height:var(--black-height); background:#000; color:#fff; border:1px solid #334155; border-top:none; border-radius:0 0 6px 6px; box-shadow:0 6px 12px rgba(0,0,0,.5); z-index:2}
  .black:active{transform:translateX(-50%) translateY(1px)}
  .blab{position:absolute; bottom:8px; left:0; right:0; text-align:center; font-size:10px; color:#e5e7eb}

  .rail{width:120px; display:flex; flex-direction:column; gap:12px}
  .oct-btn{display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(17,24,39,.8), rgba(15,23,42,.8)); border:1px solid #334155; border-radius:12px; padding:14px 10px; font-weight:800; color:#e5e7eb; box-shadow:0 8px 20px rgba(0,0,0,.25); cursor:pointer; transition:all .15s}
  .oct-btn:hover{border-color:#475569; transform:translateY(-1px)}
  .oct-btn.active{border-color:var(--accent2); box-shadow:0 0 0 2px rgba(34,211,238,.15), 0 12px 24px rgba(0,0,0,.35); color:#cffafe}
  @media (max-width: 860px){
    .kbd-wrap{flex-direction:column}
    .rail{width:100%; flex-direction:row; justify-content:space-between; gap:10px}
    .oct-btn{flex:1}
  }
  @media (min-width: 900px){
    .white{height:220px}
    .black{height:var(--black-height-lg); width:var(--black-width-lg)}
  }

  /* ---------- Mobile landscape base ---------- */
  :root{ --whiteH: clamp(160px, 38vh, 240px); }
  .card{ padding:12px; border-radius:14px }
  .label{ font-size:11px }
  .value{ font-size:clamp(16px,2.4vw,20px) }
  .big{ font-size:clamp(22px,4vw,30px) }
  .white{ height:var(--whiteH) }
  .black{ height:calc(var(--whiteH)*0.62); width:calc(var(--cellW)*0.55) }

  /* มือถือแนวนอน: 4 ช่องในบรรทัดเดียวเสมอ + ปรับขนาด */
  @media screen and (max-width: 920px) and (orientation: landscape){
    .wrap{ max-width: 100vw; padding:10px }
    h1{ font-size:clamp(16px,2.2vw,20px); margin:4px 0 8px }
    .controls{ gap:8px }
    .controls label{ font-size:12px }
    select{ padding:4px 8px; font-size:12px }
    input[type="range"]{ width:160px }
    .grid4{ grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px }
    .box{ padding:8px 10px }
    :root{ --cellW: clamp(44px, 6.8vw, 64px) }
    .keyboard{ padding:10px }
  }

  /* อุปกรณ์ที่เตี้ยมาก: ยังคง 4 ช่อง แต่รัดพิเศษ */
  @media screen and (max-height: 420px) and (orientation: landscape){
    .grid4{ grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px }
    .box{ padding:6px 8px }
    .label{ font-size:10px }
    .value{ font-size:clamp(13px,1.9vw,17px) }
    :root{ --cellW: clamp(42px, 6.6vw, 62px) }
    .white{ height:clamp(140px, 34vh, 200px) }
  }

  /* ---------- Compact cards (สูงพอดีตัวอักษร) ---------- */
  #row4{ min-height:0; }
  #row4 .box{ padding:6px 10px; }
  #row4 .label{ margin-bottom:2px; }
  #row4 .value{ line-height:1.15; }
  @media (max-width:920px) and (orientation:landscape){
    #row4 .box{ padding:6px 8px; }
    #row4 .value{ font-size:clamp(14px,2.0vw,18px); }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between">
      <h1>Note → Hz</h1>
      <div class="row controls">
        <label><input type="checkbox" id="toggleHarm" checked> แสดง Harmonics 2–4</label>
        <label><input type="checkbox" id="toggleSub" checked> แสดง Subharmonic 1/2</label>
        <label><input type="checkbox" id="togglePlay" checked> เล่นเสียงเมื่อกด</label>
        <label class="row" style="gap:8px">โหมดเสียง
          <select id="oscType">
            <option value="sine" selected>Sine</option>
            <option value="square">Square</option>
            <option value="sawtooth">Saw</option>
            <option value="triangle">Triangle</option>
            <option value="feedback">Feedback</option>
          </select>
        </label>
        <button id="pinkBtn" class="btn" aria-pressed="false">Pink Noise</button>
      </div>
    </header>

    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div>
          <div class="label">โน้ตที่เลือก</div>
          <div class="big" id="noteOut">—</div>
        </div>
        <div>
          <div class="label">ความถี่</div>
          <div class="big" id="hzOut">—</div>
        </div>
        <div class="row">
          <span class="small">โวลุ่ม</span>
          <input type="range" id="vol" min="0" max="1" step="0.01" value="0.5" style="width:200px">
        </div>
      </div>

      <div id="row4" class="grid4">
        <div class="box"><div class="label">Subharmonic × 1/2</div><div id="val-sub" class="value">—</div></div>
        <div class="box"><div class="label">Harmonic ×2</div><div id="val-h2" class="value">—</div></div>
        <div class="box"><div class="label">Harmonic ×3</div><div id="val-h3" class="value">—</div></div>
        <div class="box"><div class="label">Harmonic ×4</div><div id="val-h4" class="value">—</div></div>
      </div>
    </section>

    <section class="card">
      <div class="kbd-wrap">
        <div class="keyboard"><div id="keys" class="keys"></div></div>
        <div class="rail">
          <button class="oct-btn" data-start="1" data-end="2">C1–B2</button>
          <button class="oct-btn active" data-start="3" data-end="4">C3–B4</button>
          <button class="oct-btn" data-start="5" data-end="6">C5–B6</button>
          <button class="oct-btn" data-start="7" data-end="8">C7–B8</button>
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  const A4 = 440;
  const order = ["C","D","E","F","G","A","B"];
  const hasBlack = { C:true, D:true, E:false, F:true, G:true, A:true, B:false };
  const sharpOf = { C:"C#", D:"D#", F:"F#", G:"G#", A:"A#" };

  const noteOut = document.getElementById('noteOut');
  const hzOut = document.getElementById('hzOut');
  const vol = document.getElementById('vol');
  const toggleHarm = document.getElementById('toggleHarm');
  const toggleSub = document.getElementById('toggleSub');
  const togglePlay = document.getElementById('togglePlay');
  const oscTypeSel = document.getElementById('oscType');
  const keys = document.getElementById('keys');
  const railBtns = Array.from(document.querySelectorAll('.oct-btn'));
  const pinkBtn = document.getElementById('pinkBtn');

  const valSub = document.getElementById('val-sub');
  const valH2 = document.getElementById('val-h2');
  const valH3 = document.getElementById('val-h3');
  const valH4 = document.getElementById('val-h4');

  // kHz formatting (≥1000 Hz)
  function fmtHz(x){
    if (x==null || !isFinite(x)) return '—';
    if (x >= 1000) return (x/1000).toFixed(3) + ' kHz';
    return x.toFixed(2) + ' Hz';
  }

  // Audio master
  let audioCtx = null, master = null;
  function getCtx(){
    if(!audioCtx){ const Ctx = window.AudioContext || window.webkitAudioContext; audioCtx = new Ctx(); }
    if (audioCtx.state === 'suspended') audioCtx.resume();
    if(!master){ const g = audioCtx.createGain(); g.gain.value = 0.6; g.connect(audioCtx.destination); master = g; }
    return audioCtx;
  }
  function toMaster(node){ return node.connect(master); }

  // Utils
  function noteToMidi(note){
    const m = note.match(/^([A-Ga-g])([#b]?)(\d)$/);
    if(!m) return null;
    const name = m[1].toUpperCase(), acc = m[2], oct = +m[3];
    const baseIndex = { C:0, D:2, E:4, F:5, G:7, A:9, B:11 }[name];
    let idx = baseIndex + (acc === '#' ? 1 : acc === 'b' ? -1 : 0);
    return (oct + 1) * 12 + idx;
  }
  const midiToFreq = m => 440 * Math.pow(2, (m - 69)/12);
  const noteToFreq = n => { const m = noteToMidi(n); return m==null? null : midiToFreq(m); };

  // Tone players
  function hiAttenBasic(freq){
    if (freq >= 4180) return 0.25;      // C8–B8
    if (freq >= 2090) return 0.5;       // C7–B7
    return 1.0;
  }
  function playTone(freq, dur=0.8){
    const ctx = getCtx(), now = ctx.currentTime;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.setValueAtTime(-18, now);
    comp.knee.setValueAtTime(12, now);
    comp.ratio.setValueAtTime(6, now);
    comp.attack.setValueAtTime(0.003, now);
    comp.release.setValueAtTime(0.25, now);

    let t = Math.max(0.0001, parseFloat(vol.value));
    if (["sine","square","sawtooth","triangle"].includes(oscTypeSel.value)) t *= hiAttenBasic(freq);

    osc.type = oscTypeSel.value;
    osc.frequency.setValueAtTime(freq, now);
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(t, now + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + dur);
    osc.connect(gain).connect(comp); toMaster(comp);
    osc.start(now); osc.stop(now + dur + 0.05);
  }

  // Feedback mode
  let fbGraph = null;
  const clamp=(x,min,max)=>Math.min(max,Math.max(min,x));
  const map=(x,inMin,inMax,outMin,outMax)=> outMin + (clamp(x,inMin,inMax)-inMin)*(outMax-outMin)/(inMax-inMin);
  function startFeedback(freq){
    stopFeedback(true);
    const ctx = getCtx(); const now = ctx.currentTime;
    const attackMs = map(freq, 300, 3500, 14, 38);
    const Q = map(freq, 600, 3500, 28, 20);
    const inC3B6 = (freq >= 130 && freq <= 2000);
    const midBoost = inC3B6 ? 2.0 : 1.0;

    const gate = ctx.createGain();
    const dc = ctx.createBiquadFilter(); dc.type='highpass'; dc.frequency.value=20;
    const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=freq; bp.Q.value=Q;
    const delay = ctx.createDelay(0.03); delay.delayTime.value=0.006;
    const fb = ctx.createGain();
    const excMix = ctx.createGain(); excMix.gain.value=1.0;

    const excOsc = ctx.createOscillator(); excOsc.type='sine'; excOsc.frequency.value=freq;
    const excGain = ctx.createGain(); excGain.gain.value=0.0001;
    const noiseGain = ctx.createGain(); noiseGain.gain.value=0.0001;

    const len = Math.floor(ctx.sampleRate*0.08);
    const nb = ctx.createBuffer(1,len,ctx.sampleRate);
    const d=nb.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*0.4; }
    const noise = ctx.createBufferSource(); noise.buffer=nb; noise.connect(noiseGain).connect(excMix);

    const out = ctx.createGain();
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value=-22; comp.knee.value=12; comp.ratio.value=8; comp.attack.value=0.006; comp.release.value=0.16;

    const b8Damp = (freq>7700 && freq<8100) ? 0.5 : 1.0;
    const a8Damp = (freq>6800 && freq<7300) ? 0.7 : 1.0;
    const special = b8Damp * a8Damp;

    fb.gain.value = 0.55 * special;
    fb.gain.linearRampToValueAtTime(0.92 * special, now + attackMs/1000);
    excGain.gain.linearRampToValueAtTime(0.05 * special * midBoost, now + (attackMs*0.8)/1000);
    noiseGain.gain.linearRampToValueAtTime(0.12 * special * midBoost, now + attackMs/2000);
    noiseGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);

    excOsc.connect(excGain).connect(excMix);
    excMix.connect(gate); gate.connect(bp); bp.connect(dc).connect(out).connect(comp); toMaster(comp);
    bp.connect(delay); delay.connect(fb); fb.connect(bp);

    const baseT = Math.min(0.35, Math.max(0.0001, parseFloat(vol.value) * 0.7)) * special;
    const tgt = Math.min(0.72, baseT * midBoost);
    gate.gain.setValueAtTime(0.0001, now);
    gate.gain.linearRampToValueAtTime(tgt, now + attackMs/1000);

    excOsc.start(now); noise.start(now); noise.stop(now + 0.14);
    fbGraph = {ctx, gate, fb, excOsc, noise};
  }
  function stopFeedback(immediate=false){
    if (!fbGraph) return;
    const {ctx, gate, fb, excOsc, noise} = fbGraph; const now = ctx.currentTime;
    const rel = immediate?0.05:0.14;
    try{
      gate.gain.cancelScheduledValues(now);
      gate.gain.exponentialRampToValueAtTime(0.0001, now + rel);
      fb.gain.linearRampToValueAtTime(0.0, now + rel*0.7);
      if(noise){ try{ noise.stop(now + 0.02);}catch(e){} }
      excOsc.stop(now + rel + 0.02);
    }catch(e){}
    fbGraph = null;
  }

  // Pink noise (toggle)
  let pinkNode = null, pinkGain = null, pinkOn = false;
  function createPinkNode(ctx){
    const node = ctx.createScriptProcessor(1024, 1, 1);
    let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
    node.onaudioprocess = e => {
      const out = e.outputBuffer.getChannelData(0);
      for(let i=0;i<out.length;i++){
        const white = Math.random()*2 - 1;
        b0 = 0.99886*b0 + white*0.0555179;
        b1 = 0.99332*b1 + white*0.0750759;
        b2 = 0.96900*b2 + white*0.1538520;
        b3 = 0.86650*b3 + white*0.3104856;
        b4 = 0.55000*b4 + white*0.5329522;
        b5 = -0.7616*b5 - white*0.0168980;
        const pink = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white*0.5362;
        b6 = white*0.115926;
        out[i] = pink * 0.11;
      }
    };
    return node;
  }
  function ensurePink(){
    const ctx = getCtx();
    if (!pinkNode){
      pinkNode = createPinkNode(ctx);
      pinkGain = ctx.createGain(); pinkGain.gain.value = 0.0001;
      pinkNode.connect(pinkGain); toMaster(pinkGain);
    }
    return {ctx, pinkNode, pinkGain};
  }
  function pinkTarget(){ return Math.pow(parseFloat(vol.value), 1.2) * 0.525; }
  function pinkStart(){
    const {ctx} = ensurePink(); const now = ctx.currentTime; const t = pinkTarget();
    pinkGain.gain.cancelScheduledValues(now);
    pinkGain.gain.setValueAtTime(0.0001, now);
    pinkGain.gain.linearRampToValueAtTime(t, now + 0.02);
    pinkOn = true; pinkBtn.classList.add('on'); pinkBtn.setAttribute('aria-pressed','true');
  }
  function pinkStop(){
    if (!pinkGain) return;
    const ctx = getCtx(); const now = ctx.currentTime;
    pinkGain.gain.cancelScheduledValues(now);
    pinkGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
    pinkOn = false; pinkBtn.classList.remove('on'); pinkBtn.setAttribute('aria-pressed','false');
  }
  pinkBtn.addEventListener('click', ()=> (pinkOn ? pinkStop() : pinkStart()));
  vol.addEventListener('input', ()=>{
    if (pinkOn && pinkGain){
      const ctx = getCtx(); const now = ctx.currentTime; const t = pinkTarget();
      pinkGain.gain.cancelScheduledValues(now);
      pinkGain.gain.linearRampToValueAtTime(t, now + 0.05);
    }
  });

  // UI helpers
  function labelWithEnharmonic(note){
    const m = note.match(/^([A-G])(#)(\d)$/);
    if(!m) return note;
    const base = m[1], oct = m[3];
    const enhMap = { C:'Db', D:'Eb', F:'Gb', G:'Ab', A:'Bb' };
    return `${base}#${oct} (${enhMap[base]}${oct})`;
  }

  function onPress(note){
    const hz = noteToFreq(note);
    const label = note.includes('#') ? labelWithEnharmonic(note) : note;
    noteOut.textContent = label; hzOut.textContent = fmtHz(hz);
    updateRowValues(hz);
    if(!togglePlay.checked || !hz) return;
    const mode = oscTypeSel.value;
    if (mode === 'feedback') startFeedback(hz);
    else playTone(hz);
  }
  function onRelease(){ if (oscTypeSel.value === 'feedback') stopFeedback(false); }

  function updateRowValues(base){
    valSub.textContent = (toggleSub.checked && base) ? fmtHz(base/2) : '—';
    if (toggleHarm.checked && base){
      valH2.textContent=fmtHz(base*2);
      valH3.textContent=fmtHz(base*3);
      valH4.textContent=fmtHz(base*4);
    }else{
      valH2.textContent='—'; valH3.textContent='—'; valH4.textContent='—';
    }
  }

  // Build keyboard & rail
  railBtns.forEach(btn => {
    btn.addEventListener('click', ()=>{
      railBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const start = +btn.dataset.start, end = +btn.dataset.end;
      buildKeyboard({start,end});
    });
  });

  function bindKey(btn, note){
    btn.addEventListener('pointerdown', (e)=>{
      e.preventDefault(); onPress(note);
      const end=()=>{ onRelease(); window.removeEventListener('pointerup', end, true); window.removeEventListener('pointercancel', end, true); };
      window.addEventListener('pointerup', end, true); window.addEventListener('pointercancel', end, true);
    }, {passive:false});
  }

  function buildKeyboard(range){
    keys.innerHTML = '';
    for (let oct = range.start; oct <= range.end; oct++){
      for (const w of order){
        const wn = `${w}${oct}`;
        const cell = document.createElement('div'); cell.className='cell';
        const wbtn = document.createElement('button'); wbtn.type='button'; wbtn.className='white'; wbtn.innerHTML='<span class="wlab">'+wn+'</span>'; bindKey(wbtn, wn); cell.appendChild(wbtn);
        if (hasBlack[w]){ const bn = { C:"C#", D:"D#", F:"F#", G:"G#", A:"A#" }[w]+oct;
          const bbtn=document.createElement('button'); bbtn.type='button'; bbtn.className='black'; bbtn.innerHTML='<span class="blab">'+bn+'</span>'; bindKey(bbtn, bn); cell.appendChild(bbtn);
        }
        keys.appendChild(cell);
      }
    }
  }

  buildKeyboard({start:3,end:4}); // default
  updateRowValues(null);
})();
</script>
</body>
</html>
